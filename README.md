# 恒大物业 Home Assistant 集成

[![hacs_badge](https://img.shields.io/badge/HACS-Custom-41BDF5.svg)](https://github.com/hacs/integration)

这是一个为 Home Assistant 开发的恒大物业自定义集成，通过抓包恒大智慧社区 APP 获取相关用户认证信息，实现对物业费用的自动化监控和管理。

## 功能特点

- **多维度费用监控**：支持已交物业费、预交物业费、待交物业费三种费用类型
- **详细费用分类**：包括住宅物业费、公摊水费、公摊电费、电梯电费、水泵电费、梯灯电费、车位服务费等
- **智能数据聚合**：自动获取最近一个月的已交费用数据，并对同一个月内的多个记录进行求和
- **年度数据查询**：可配置查询特定年份的物业费用数据
- **合计统计**：提供预交费用合计、月公摊费、待交费用合计等统计功能
- **实时更新**：自动更新数据，并提供更新时间显示

## 安装方法

### 方法一：HACS 安装（推荐）
1. 确保已安装 [HACS](https://hacs.xyz/)
2. 在 HACS 的 "Integrations" 页面，点击右上角的三个点菜单，选择 "Custom repositories"
3. 在弹出窗口中添加仓库地址：https://github.com/lambilly/hass_hengda_property/ ，类别选择 "Integration"
4. 在 HACS 中搜索 "恒大物业"
5. 点击下载
6. 重启 Home Assistant

### 方法二：手动安装
1. 将 `hengda_property` 文件夹复制到 `config/custom_components` 目录
2. 重启 Home Assistant

## 配置步骤

### 获取认证信息
1. 使用抓包工具（如 Charles、Fiddler 等）捕获恒大智慧社区 APP 的网络请求
2. 找到包含物业费用相关 API 的请求
3. 从请求头中提取以下信息：
   - `unionId`
   - `authorization`

### 在 Home Assistant 中配置
1. 进入 Home Assistant 的 "配置" -> "集成"
2. 点击右下角的 "+ 添加集成"
3. 搜索 "恒大物业"
4. 填写以下信息：
   - **Union ID**: 从抓包数据中获取的 unionId
   - **Authorization Token**: 从抓包数据中获取的 authorization
   - **数据年份**: 要查询的物业费用年份

## 实体说明

### 设备一：已交物业费
- 住宅物业费
- 公摊水费
- 公摊电费
- 电梯电费
- 水泵电费
- 梯灯电费
- 车位服务费
- 月公摊费（合计）
- 更新时间

### 设备二：预交物业费
- 住宅物业费
- 公摊水费
- 公摊电费
- 电梯电费
- 水泵电费
- 梯灯电费
- 车位服务费
- 预交费用合计
- 更新时间

### 设备三：待交物业费
- 住宅物业费
- 公摊水费
- 公摊电费
- 电梯电费
- 水泵电费
- 梯灯电费
- 车位服务费
- 待交费用合计
- 更新时间

## 数据更新

- 集成默认每 24 小时自动更新一次数据
- 可以通过手动调用服务强制更新
- 更新时间实体显示最后一次成功获取数据的时间

## 注意事项

1. **认证信息获取**：需要定期更新认证信息，因为 token 可能会过期
2. **数据准确性**：集成显示的数据与恒大智慧社区 APP 保持一致
3. **网络要求**：需要能够访问 `h5.hengdayun.com` 域名
4. **隐私保护**：认证信息仅存储在本地 Home Assistant 实例中

## 故障排除

### 常见问题

1. **集成无法连接**
   - 检查网络连接是否正常
   - 确认认证信息是否正确且未过期
   - 查看日志文件获取详细错误信息

2. **数据显示为 0**
   - 确认配置的年份是否正确
   - 检查该年份是否有对应的物业费用数据
   - 验证认证信息是否有权限访问数据

3. **实体不可用**
   - 重启 Home Assistant
   - 检查集成配置是否正确
   - 查看 Home Assistant 日志获取错误详情

### 日志查看

如需查看详细日志，请在 Home Assistant 的 `configuration.yaml` 中添加：

```yaml
logger:
  default: info
  logs:
    custom_components.hengda_property: debug
```

## 技术支持

如遇问题，请：
1. 查看 Home Assistant 日志文件
2. 确认认证信息是否正确
3. 检查网络连接是否正常
4. 在项目 GitHub 页面提交 Issue

## 免责声明

本集成仅供个人学习和研究使用，请勿用于商业用途。使用本集成即表示您同意自行承担因使用该集成而产生的所有风险。开发者不对因使用本集成而导致的任何直接或间接损失负责。

## 更新日志

### v1.0.0
- 初始版本发布
- 支持已交、预交、待交物业费查询
- 提供费用合计和更新时间功能
- 支持年度数据查询

---

**作者**: lambilly  
**许可证**: MIT License
